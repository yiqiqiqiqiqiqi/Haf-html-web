<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>World History Explorer</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            text-align: center;
            margin: 0;
            padding: 20px;
            background-image: url('https://images.unsplash.com/photo-1506318137071-a8e063b4bec0?ixlib=rb-1.2.1&auto=format&fit=crop&w=1350&q=80');
            background-size: cover;
            background-attachment: fixed;
            background-position: center;
            color: #2c3e50;
            min-height: 100vh;
            overflow-x: hidden;
        }
        #game-container {
            max-width: 850px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.93);
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 0 25px rgba(0,0,0,0.25);
            backdrop-filter: blur(8px);
        }
        button {
            padding: 12px 28px;
            margin: 10px;
            font-size: 17px;
            cursor: pointer;
            background-color: #4a6fa5;
            color: white;
            border: none;
            border-radius: 10px;
            transition: all 0.3s;
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
            font-weight: bold;
            min-width: 120px;
        }
        button:hover:not(:disabled) {
            transform: translateY(-3px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.2);
        }
        button:active:not(:disabled) {
            transform: translateY(1px);
        }
        button:disabled {
            background-color: #95a5a6;
            cursor: not-allowed;
        }
        #question, #score, #result, #mentor, #leaderboard, #hint, #progress, #explanation, #era-info, #streak-counter {
            margin: 20px 0;
            font-size: 19px;
            opacity: 0;
            animation: fadeIn 1s forwards;
        }
        #question {
            font-size: 22px;
            font-weight: bold;
            color: #2c3e50;
            min-height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1.4;
        }
        #mentor img {
            width: 130px;
            height: 130px;
            border-radius: 50%;
            margin-top: 15px;
            transition: all 0.5s;
            border: 5px solid #4a6fa5;
            object-fit: cover;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        #mentor img:hover {
            transform: rotate(360deg);
            border-color: #e74c3c;
        }
        @keyframes fadeIn {
            to { opacity: 1; }
        }
        .shake {
            animation: shake 0.5s;
        }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }
        #leaderboard, #progress, #era-info, #streak-counter {
            background: rgba(233, 236, 239, 0.85);
            padding: 15px;
            border-radius: 10px;
            font-weight: bold;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        #choices button {
            display: block;
            width: 90%;
            margin: 15px auto;
            padding: 15px;
            text-align: center;
            font-size: 16px;
        }
        #explanation {
            font-size: 17px;
            color: #555;
            background: rgba(255, 255, 255, 0.8);
            padding: 20px;
            border-radius: 10px;
            border-left: 6px solid #4a6fa5;
            line-height: 1.6;
        }
        .civilization-tag {
            display: inline-block;
            padding: 6px 15px;
            margin: 8px;
            background-color: #6c757d;
            color: white;
            border-radius: 25px;
            font-size: 15px;
            font-weight: bold;
            transition: all 0.3s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .civilization-tag:hover {
            background-color: #4a6fa5;
            transform: scale(1.05);
        }
        #timeline {
            height: 30px;
            background: linear-gradient(90deg, #ff7675, #74b9ff, #55efc4, #ffeaa7, #a29bfe);
            margin: 30px 0;
            border-radius: 15px;
            position: relative;
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        #timeline-marker {
            position: absolute;
            width: 18px;
            height: 40px;
            background: #2c3e50;
            top: -5px;
            left: 0;
            border-radius: 8px;
            box-shadow: 0 3px 6px rgba(0,0,0,0.25);
            transition: left 1s ease-in-out;
        }
        #timeline-labels {
            display: flex;
            justify-content: space-between;
            margin-top: 8px;
            font-size: 14px;
            font-weight: bold;
            color: #2c3e50;
        }
        #sound-controls {
            position: fixed;
            bottom: 25px;
            right: 25px;
            background: rgba(255,255,255,0.9);
            padding: 12px;
            border-radius: 50px;
            box-shadow: 0 3px 8px rgba(0,0,0,0.25);
            z-index: 100;
            display: flex;
            gap: 10px;
        }
        #sound-controls button {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            padding: 0;
            margin: 0;
            font-size: 22px;
            min-width: auto;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .correct {
            background-color: #2ecc71 !important;
            animation: pulseCorrect 0.5s;
        }
        .wrong {
            background-color: #e74c3c !important;
            animation: pulseWrong 0.5s;
        }
        @keyframes pulseCorrect {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        @keyframes pulseWrong {
            0% { transform: scale(1); }
            50% { transform: scale(0.95); }
            100% { transform: scale(1); }
        }
        #unlock-notification {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(135deg, #4a6fa5, #2ecc71);
            color: white;
            padding: 25px 50px;
            border-radius: 15px;
            font-size: 28px;
            font-weight: bold;
            z-index: 1000;
            display: none;
            box-shadow: 0 8px 25px rgba(0,0,0,0.3);
            animation: unlockFade 2.5s;
            text-align: center;
            border: 3px solid white;
        }
        @keyframes unlockFade {
            0% { opacity: 0; transform: translate(-50%, -50%) scale(0.7); }
            20% { opacity: 1; transform: translate(-50%, -50%) scale(1.1); }
            80% { opacity: 1; transform: translate(-50%, -50%) scale(1.1); }
            100% { opacity: 0; transform: translate(-50%, -50%) scale(0.8); }
        }
        #score-display {
            display: flex;
            justify-content: space-around;
            margin: 20px 0;
            gap: 20px;
        }
        #score-display > div {
            flex: 1;
            padding: 15px;
            border-radius: 10px;
            background: rgba(233, 236, 239, 0.85);
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        #mentor-bonus {
            font-size: 16px;
            color: #27ae60;
            font-style: italic;
            margin-top: 8px;
        }
        .difficulty-indicator {
            display: inline-block;
            width: 15px;
            height: 15px;
            border-radius: 50%;
            margin-left: 8px;
        }
        .difficulty-easy {
            background-color: #2ecc71;
        }
        .difficulty-medium {
            background-color: #f39c12;
        }
        .difficulty-hard {
            background-color: #e74c3c;
        }
        #question-counter {
            font-size: 16px;
            color: #7f8c8d;
            margin-top: 10px;
        }
        #achievements {
            position: fixed;
            top: 20px;
            left: 20px;
            background: rgba(255,255,255,0.9);
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 3px 8px rgba(0,0,0,0.2);
            z-index: 1050;
            max-width: 250px;
            display: none;
        }
        #achievements h3 {
            margin-top: 0;
            color: #4a6fa5;
            border-bottom: 2px solid #4a6fa5;
            padding-bottom: 8px;
        }
        .achievement-item {
            margin: 10px 0;
            padding: 8px;
            background: rgba(233, 236, 239, 0.7);
            border-radius: 5px;
            display: flex;
            align-items: center;
        }
        .achievement-icon {
            font-size: 24px;
            margin-right: 10px;
            color: #f39c12;
        }
        #achievement-badge {
            position: fixed;
            top: 20px;
            left: 20px;
            background: #e74c3c;
            color: white;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 3px 8px rgba(0,0,0,0.3);
            z-index: 1051;
        }
        #question-timer {
            height: 5px;
            background: #ddd;
            margin: 15px 0;
            border-radius: 5px;
            overflow: hidden;
            display: none;
        }
        #timer-bar {
            height: 100%;
            width: 100%;
            background: #4a6fa5;
            transition: width 1s linear;
        }
        #settings-panel {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
            z-index: 1100;
            display: none;
            max-width: 500px;
            width: 90%;
            animation: fadeInModal 0.3s ease-in-out;
        }
        #settings-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1099;
            display: none;
        }
        #settings-panel h2 {
            margin-top: 0;
            color: #4a6fa5;
            border-bottom: 2px solid #4a6fa5;
            padding-bottom: 10px;
        }
        .settings-option {
            margin: 15px 0;
        }
        .settings-option label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
        }
        #close-settings {
            position: absolute;
            top: 15px;
            right: 15px;
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #7f8c8d;
        }
        #settings-button {
            position: fixed;
            bottom: 25px;
            left: 25px;
            background: rgba(255,255,255,0.9);
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 3px 8px rgba(0,0,0,0.2);
            z-index: 100;
        }
        @keyframes fadeInModal {
            from { opacity: 0; transform: translate(-50%, -60%); }
            to { opacity: 1; transform: translate(-50%, -50%); }
        }
        @media (max-width: 600px) {
            #game-container {
                padding: 15px;
            }
            button {
                padding: 10px 20px;
                font-size: 15px;
                min-width: 100px;
            }
            #settings-panel {
                padding: 20px;
                width: 95%;
                max-width: 400px;
            }
            #question {
                font-size: 18px;
            }
            #sound-controls, #settings-button, #achievement-badge {
                transform: scale(0.8);
            }
        }
        .keyword-tag {
            background-color: #4a6fa5;
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: bold;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            text-decoration: none;
            display: inline-block;
        }
        .keyword-tag:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            background-color: #2c3e50;
            color: white;
            text-decoration: none;
        }
    </style>
</head>
<body>
    <div id="settings-backdrop"></div>
    <div id="game-container">
        <div id="logo-section" style="text-align: center; margin-bottom: 20px;">
            <a href="history.html"><img src="images/historylogo.png" alt="HAF Logo" style="max-width: 200px; height: auto; margin-bottom: 15px;"></a>
            <div id="keywords" style="display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; margin: 10px 0;">
                <a href="history.html" class="keyword-tag">History</a>
                <a href="world_history.html" class="keyword-tag">World History</a>
                <a href="malaysia_history.html" class="keyword-tag">Malaysia History</a>
                <a href="history_game.html" class="keyword-tag">History Game</a>
                <a href="art.html" class="keyword-tag">Art</a>
                <a href="fashion.html" class="keyword-tag">Fashion</a>
            </div>
        </div>
        <h1 id="title">World History Explorer</h1>
        
        <div id="timeline">
            <div id="timeline-marker"></div>
        </div>
        <div id="timeline-labels">
            <span>Ancient</span>
            <span>Classical</span>
            <span>Middle Ages</span>
            <span>Early Modern</span>
            <span>Modern</span>
        </div>
        
        <div id="era-info">Current Era: Ancient Civilizations</div>
        <div id="question-timer"><div id="timer-bar"></div></div>
        <div id="mentor">Mentor: Not selected<br><img id="mentor-img" src="" style="display: none;"></div>
        <div id="mentor-bonus"></div>
        
        <div id="score-display">
            <div id="score">Score: 0</div>
            <div id="leaderboard">High Score: 0</div>
            <div id="streak-counter">Streak: 0</div>
        </div>
        
        <div id="progress">Unlocked Civilizations: Mesopotamia, Ancient Egypt</div>
        <div id="question">Click "New Question" to start exploring!</div>
        <div id="hint"></div>
        <div id="choices"></div>
        <div id="result"></div>
        <div id="explanation"></div>
        <div id="question-counter">Questions Answered: 0</div>
        
        <div>
            <button id="next-question" aria-label="Get New Question">New Question</button>
            <button id="hint-button" style="background-color: #27ae60;" aria-label="Show Hint">Hint</button>
            <button id="reset-score" style="background-color: #e74c3c;" aria-label="Reset Score">Reset Score</button>
        </div>
    </div>

    <div id="sound-controls">
        <button id="music-toggle" aria-label="Toggle Music">🎵</button>
        <button id="sound-toggle" aria-label="Toggle Sound">🔊</button>
    </div>

    <div id="achievement-badge" title="View Achievements" aria-label="View Achievements">🏆</div>
    
    <div id="achievements">
        <h3 id="achievements-title">Achievements</h3>
        <div id="achievements-list"></div>
    </div>

    <div id="settings-button" title="Open Settings" aria-label="Open Settings">⚙️</div>
    
    <div id="settings-panel" role="dialog" aria-labelledby="settings-title">
        <button id="close-settings" aria-label="Close Settings">×</button>
        <h2 id="settings-title">Settings</h2>
        <div class="settings-option">
            <label id="music-label">Background Music</label>
            <button id="music-toggle-setting" aria-label="Toggle Background Music">Disable Music</button>
        </div>
        <div class="settings-option">
            <label id="sound-label">Sound Effects</label>
            <button id="sound-toggle-setting" aria-label="Toggle Sound Effects">Disable Sound</button>
        </div>
        <div class="settings-option">
            <label id="timer-label">Question Timer</label>
            <button id="timer-toggle-setting" aria-label="Toggle Question Timer">Disable Timer</button>
        </div>
        <div class="settings-option">
            <label id="difficulty-label">Difficulty Level</label>
            <select id="difficulty-select" aria-label="Select Difficulty">
                <option value="easy">Easy</option>
                <option value="medium" selected>Medium</option>
                <option value="hard">Hard</option>
            </select>
        </div>
    </div>

    <div id="unlock-notification"></div>

    <!-- Audio System -->
    <audio id="bg-music" preload="auto" loop>
        <source src="https://assets.mixkit.co/music/preview/mixkit-epic-historic-adventure-1497.mp3" type="audio/mpeg">
    </audio>
    <audio id="success-sound" preload="auto">
        <source src="https://assets.mixkit.co/sfx/preview/mixkit-achievement-bell-600.mp3" type="audio/mpeg">
    </audio>
    <audio id="fail-sound" preload="auto">
        <source src="https://assets.mixkit.co/sfx/preview/mixkit-wrong-answer-fail-notification-946.mp3" type="audio/mpeg">
    </audio>
    <audio id="hint-sound" preload="auto">
        <source src="https://assets.mixkit.co/sfx/preview/mixkit-magic-sparkle-902.mp3" type="audio/mpeg">
    </audio>
    <audio id="page-sound" preload="auto">
        <source src="https://assets.mixkit.co/sfx/preview/mixkit-book-page-turning-1561.mp3" type="audio/mpeg">
    </audio>
    <audio id="unlock-sound" preload="auto">
        <source src="https://assets.mixkit.co/sfx/preview/mixkit-unlock-game-notification-253.mp3" type="audio/mpeg">
    </audio>
    <audio id="button-sound" preload="auto">
        <source src="https://assets.mixkit.co/sfx/preview/mixkit-select-click-1109.mp3" type="audio/mpeg">
    </audio>
    <audio id="correct-sound" preload="auto">
        <source src="https://assets.mixkit.co/sfx/preview/mixkit-correct-answer-tone-2870.mp3" type="audio/mpeg">
    </audio>
    <audio id="wrong-sound" preload="auto">
        <source src="https://assets.mixkit.co/sfx/preview/mixkit-wrong-electric-buzz-2927.mp3" type="audio/mpeg">
    </audio>
    <audio id="era-change-sound" preload="auto">
        <source src="https://assets.mixkit.co/sfx/preview/mixkit-ominous-drums-561.mp3" type="audio/mpeg">
    </audio>
    <audio id="achievement-sound" preload="auto">
        <source src="https://assets.mixkit.co/sfx/preview/mixkit-achievement-completed-2068.mp3" type="audio/mpeg">
    </audio>
    <audio id="streak-sound" preload="auto">
        <source src="https://assets.mixkit.co/sfx/preview/mixkit-positive-interface-beep-221.mp3" type="audio/mpeg">
    </audio>

    <script>
        // XLSX File Handling
        var gk_isXlsx = false;
        var gk_xlsxFileLookup = {};
        var gk_fileData = {};
        function filledCell(cell) {
            return cell !== '' && cell != null;
        }
        function loadFileData(filename) {
            if (gk_isXlsx && gk_xlsxFileLookup[filename]) {
                try {
                    var workbook = XLSX.read(gk_fileData[filename], { type: 'base64' });
                    var firstSheetName = workbook.SheetNames[0];
                    var worksheet = workbook.Sheets[firstSheetName];
                    var jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, blankrows: false, defval: '' });
                    var filteredData = jsonData.filter(row => row.some(filledCell));
                    var headerRowIndex = filteredData.findIndex((row, index) =>
                        row.filter(filledCell).length >= filteredData[index + 1]?.filter(filledCell).length
                    );
                    if (headerRowIndex === -1 || headerRowIndex > 25) {
                        headerRowIndex = 0;
                    }
                    var csv = XLSX.utils.aoa_to_sheet(filteredData.slice(headerRowIndex));
                    csv = XLSX.utils.sheet_to_csv(csv, { header: 1 });
                    return csv;
                } catch (e) {
                    console.error('XLSX parsing error:', e);
                    return "";
                }
            }
            return gk_fileData[filename] || "";
        }

        // Game State
        let score = parseInt(localStorage.getItem('score')) || 0;
        let highScore = parseInt(localStorage.getItem('highScore')) || 0;
        let currentQuestion = null;
        let currentMentor = null;
        let correctAnswers = 0;
        let unlockedCivilizations = ['Mesopotamia', 'Ancient Egypt'];
        let currentEra = 'Ancient Civilizations';
        let timelinePosition = 0;
        let musicEnabled = true;
        let soundEnabled = true;
        let currentStreak = 0;
        let highestStreak = 0;
        let totalQuestionsAnswered = 0;
        let timerEnabled = false;
        let timerInterval = null;
        let difficulty = 'medium';
        let isProcessing = false;
        let questionHistory = [];

        const translations = {
            title: 'World History Explorer',
            newQuestion: 'New Question',
            hint: 'Hint',
            resetScore: 'Reset Score',
            settings: 'Settings',
            musicLabel: 'Background Music',
            soundLabel: 'Sound Effects',
            timerLabel: 'Question Timer',
            difficultyLabel: 'Difficulty Level',
            achievements: 'Achievements',
            score: 'Score',
            highScore: 'High Score',
            streak: 'Streak',
            unlockedCivs: 'Unlocked Civilizations',
            currentEra: 'Current Era',
            questionsAnswered: 'Questions Answered',
            noQuestions: 'No more questions! Try unlocking more civilizations or eras.',
            scoreReset: 'Score reset!',
            mentor: 'Mentor',
            mentorBonus: 'Mentor Bonus',
            mentorNotSelected: 'Mentor: Not selected',
            selectMentor: 'Select Mentor',
            noMentorHint: 'Hint: Please select a mentor first',
            noQuestionHint: 'Hint: Please start a question first',
            correct: 'Correct! Earned {points} points (Streak x{streak})',
            wrong: 'Wrong!',
            civUnlocked: 'New civilization unlocked: {civ}',
            eraUnlocked: 'New era unlocked: {era}',
            achievementUnlocked: 'Achievement Unlocked: {name}',
            enable: 'Enable',
            disable: 'Disable'
        };

        const achievements = {
            firstAnswer: { earned: false, name: 'First Answer', desc: 'Answer your first question' },
            fiveStreak: { earned: false, name: 'Five Streak', desc: 'Answer 5 questions correctly in a row' },
            unlockAll: { earned: false, name: 'Unlock Master', desc: 'Unlock all civilizations and eras' },
            perfectScore: { earned: false, name: 'Perfect Score', desc: 'Reach 1000 points' },
            historyBuff: { earned: false, name: 'History Buff', desc: 'Answer 50 questions' }
        };

        const mentors = {
            herodotus: { 
                name: 'Herodotus', 
                bonus: 1.3,
                hintStyle: 'Father of History says: ',
                img: 'https://upload.wikimedia.org/wikipedia/commons/thumb/d/dd/Herodotus_Met_91.8.jpg/220px-Herodotus_Met_91.8.jpg',
                specialty: ['Ancient Greece', 'Ancient Persia'],
                quote: '"History is the record of human actions"'
            },
            simaqian: { 
                name: 'Sima Qian', 
                bonus: 1.4,
                hintStyle: 'Grand Historian notes: ',
                img: 'https://upload.wikimedia.org/wikipedia/commons/thumb/5/5f/Sima_Qian.jpg/220px-Sima_Qian.jpg',
                specialty: ['Ancient China', 'Han Dynasty'],
                quote: '"To explore the relation between heaven and man"'
            },
            ibnkhaldun: { 
                name: 'Ibn Khaldun', 
                bonus: 1.5,
                hintStyle: 'Father of Sociology suggests: ',
                img: 'https://upload.wikimedia.org/wikipedia/commons/thumb/7/7e/Ibn_Khaldun.jpg/220px-Ibn_Khaldun.jpg',
                specialty: ['Islamic Civilization', 'Middle Ages'],
                quote: '"History is the mirror of human society"'
            }
        };

        const eras = [
            { name: 'Ancient Civilizations', civilizations: ['Mesopotamia', 'Ancient Egypt', 'Ancient India', 'Ancient China'], position: 0, color: '#ff7675' },
            { name: 'Classical Age', civilizations: ['Ancient Greece', 'Ancient Rome', 'Persian Empire', 'Qin-Han'], position: 25, color: '#74b9ff' },
            { name: 'Middle Ages', civilizations: ['Byzantine', 'Islamic Civilization', 'Tang-Song', 'Feudal Europe'], position: 50, color: '#55efc4' },
            { name: 'Early Modern', civilizations: ['Renaissance', 'Age of Exploration', 'Ming-Qing', 'Ottoman'], position: 75, color: '#ffeaa7' },
            { name: 'Modern World', civilizations: ['Industrial Revolution', 'Colonial Era', 'World Wars', 'Contemporary'], position: 100, color: '#a29bfe' }
        ];

        const questions = [
            {
                civilizations: ['Mesopotamia'],
                era: 'Ancient Civilizations',
                question: 'Which civilization developed the world\'s earliest known writing system?',
                choices: ['Ancient Egypt', 'Mesopotamia', 'Ancient India', 'Ancient China'],
                answer: 1,
                explanation: 'The Sumerians of Mesopotamia developed cuneiform script around 3400 BCE, the earliest known writing system.',
                difficulty: 1
            },
            {
                civilizations: ['Ancient Egypt'],
                era: 'Ancient Civilizations',
                question: 'In which century was the tomb of Pharaoh Tutankhamun discovered?',
                choices: ['18th century', '19th century', '20th century', '21st century'],
                answer: 2,
                explanation: 'Tutankhamun\'s tomb was discovered by Howard Carter in 1922, one of the greatest archaeological finds of the 20th century.',
                difficulty: 2
            },
            {
                civilizations: ['Ancient Greece'],
                era: 'Classical Age',
                question: 'Under which leader did Athenian democracy reach its peak?',
                choices: ['Solon', 'Cleisthenes', 'Pericles', 'Alexander'],
                answer: 2,
                explanation: 'The Age of Pericles (461-429 BCE) was the golden age of Athenian democracy and cultural development.',
                difficulty: 2,
                unlockRequirement: 5
            },
            {
                civilizations: ['Ancient Egypt'],
                era: 'Ancient Civilizations',
                question: 'Which pharaoh built the Great Pyramid of Giza?',
                choices: ['Ramses II', 'Khufu', 'Tutankhamun', 'Cleopatra'],
                answer: 1,
                explanation: 'Khufu (also known as Cheops) built the Great Pyramid of Giza around 2560 BCE.',
                difficulty: 1
            },
            {
                civilizations: ['Ancient China'],
                era: 'Ancient Civilizations',
                question: 'Which Chinese dynasty is known for the construction of the Great Wall?',
                choices: ['Han Dynasty', 'Qin Dynasty', 'Tang Dynasty', 'Ming Dynasty'],
                answer: 1,
                explanation: 'The Qin Dynasty (221-206 BCE) began the construction of the Great Wall to protect against northern invasions.',
                difficulty: 1
            }
        ];

        // Initialize Game
        function initGame() {
            loadSettings();
            loadGameState();
            updateUI();
            updateTimeline();
            initMentorButtons();
            bindButtonEvents();
            if (musicEnabled) {
                document.getElementById('bg-music').play().catch(e => console.log("Music autoplay prevented:", e));
            }
            loadAchievements();
            updateAchievementsDisplay();
            document.getElementById('difficulty-select').addEventListener('change', setDifficulty);
        }

        // Bind Button Events
        function bindButtonEvents() {
            document.getElementById('next-question').addEventListener('click', debouncedNextQuestion);
            document.getElementById('hint-button').addEventListener('click', showHint);
            document.getElementById('reset-score').addEventListener('click', resetScore);
            document.getElementById('music-toggle').addEventListener('click', toggleMusic);
            document.getElementById('sound-toggle').addEventListener('click', toggleSound);
            document.getElementById('achievement-badge').addEventListener('click', toggleAchievements);
            document.getElementById('settings-button').addEventListener('click', showSettings);
            document.getElementById('close-settings').addEventListener('click', hideSettings);
            document.getElementById('music-toggle-setting').addEventListener('click', toggleMusic);
            document.getElementById('sound-toggle-setting').addEventListener('click', toggleSound);
            document.getElementById('timer-toggle-setting').addEventListener('click', toggleTimer);
        }

        // Load Game State
        function loadGameState() {
            score = parseInt(localStorage.getItem('score')) || 0;
            highScore = parseInt(localStorage.getItem('highScore')) || 0;
            updateUI();
        }

        // Save Game State
        function saveGameState() {
            localStorage.setItem('score', score);
            localStorage.setItem('highScore', highScore);
        }

        // Load Settings
        function loadSettings() {
            const savedMusic = localStorage.getItem('musicEnabled_1.0');
            const savedSound = localStorage.getItem('soundEnabled_1.0');
            const savedTimer = localStorage.getItem('timerEnabled_1.0');
            const savedDifficulty = localStorage.getItem('difficulty_1.0');
            
            if (savedMusic !== null) musicEnabled = savedMusic === 'true';
            if (savedSound !== null) soundEnabled = savedSound === 'true';
            if (savedTimer !== null) timerEnabled = savedTimer === 'true';
            if (savedDifficulty !== null) difficulty = savedDifficulty;
            
            document.getElementById('music-toggle').textContent = musicEnabled ? '🎵' : '🔇';
            document.getElementById('sound-toggle').textContent = soundEnabled ? '🔊' : '🔇';
            document.getElementById('question-timer').style.display = timerEnabled ? 'block' : 'none';
            document.getElementById('difficulty-select').value = difficulty;
            updateUI();
        }

        // Save Settings
        function saveSettings() {
            localStorage.setItem('musicEnabled_1.0', musicEnabled);
            localStorage.setItem('soundEnabled_1.0', soundEnabled);
            localStorage.setItem('timerEnabled_1.0', timerEnabled);
            localStorage.setItem('difficulty_1.0', difficulty);
        }

        // Load Achievements
        function loadAchievements() {
            const savedAchievements = localStorage.getItem('achievements_1.0');
            if (savedAchievements) {
                const parsed = JSON.parse(savedAchievements);
                for (const key in parsed) {
                    if (achievements[key]) {
                        achievements[key].earned = parsed[key].earned;
                    }
                }
            }
        }

        // Save Achievements
        function saveAchievements() {
            localStorage.setItem('achievements_1.0', JSON.stringify(achievements));
        }

        // Play Sound
        function playSound(soundId) {
            if (!soundEnabled && soundId !== 'bg-music') return;
            if (!musicEnabled && soundId === 'bg-music') return;
            const sound = document.getElementById(soundId);
            if (sound) {
                sound.currentTime = 0;
                sound.play().catch(e => console.error('Audio play failed:', e));
            }
        }

        // Toggle Music
        function toggleMusic() {
            musicEnabled = !musicEnabled;
            const music = document.getElementById('bg-music');
            if (musicEnabled) {
                music.play().catch(console.error);
                document.getElementById('music-toggle').textContent = '🎵';
                document.getElementById('music-toggle-setting').textContent = `${translations.musicLabel}: ${translations.disable}`;
            } else {
                music.pause();
                document.getElementById('music-toggle').textContent = '🔇';
                document.getElementById('music-toggle-setting').textContent = `${translations.musicLabel}: ${translations.enable}`;
            }
            saveSettings();
            playSound('button-sound');
        }

        // Toggle Sound
        function toggleSound() {
            soundEnabled = !soundEnabled;
            document.getElementById('sound-toggle').textContent = soundEnabled ? '🔊' : '🔇';
            document.getElementById('sound-toggle-setting').textContent = `${translations.soundLabel}: ${soundEnabled ? translations.disable : translations.enable}`;
            saveSettings();
            playSound('button-sound');
        }

        // Toggle Timer
        function toggleTimer() {
            timerEnabled = !timerEnabled;
            document.getElementById('question-timer').style.display = timerEnabled ? 'block' : 'none';
            document.getElementById('timer-toggle-setting').textContent = `${translations.timerLabel}: ${timerEnabled ? translations.disable : translations.enable}`;
            if (!timerEnabled && timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
            saveSettings();
            playSound('button-sound');
        }

        // Set Difficulty
        function setDifficulty() {
            difficulty = document.getElementById('difficulty-select').value;
            saveSettings();
            playSound('button-sound');
        }

        // Show Settings
        function showSettings() {
            document.getElementById('settings-panel').style.display = 'block';
            document.getElementById('settings-backdrop').style.display = 'block';
            playSound('button-sound');
        }

        // Hide Settings
        function hideSettings() {
            document.getElementById('settings-panel').style.display = 'none';
            document.getElementById('settings-backdrop').style.display = 'none';
            playSound('button-sound');
        }

        // Toggle Achievements
        function toggleAchievements() {
            const panel = document.getElementById('achievements');
            panel.style.display = panel.style.display === 'block' ? 'none' : 'block';
            playSound('button-sound');
        }

        // Update Achievements Display
        function updateAchievementsDisplay() {
            const list = document.getElementById('achievements-list');
            list.innerHTML = '';
            for (const key in achievements) {
                const achievement = achievements[key];
                const item = document.createElement('div');
                item.className = 'achievement-item';
                const icon = document.createElement('span');
                icon.className = 'achievement-icon';
                icon.textContent = achievement.earned ? '🏆' : '🔒';
                item.appendChild(icon);
                const text = document.createElement('div');
                const name = document.createElement('strong');
                name.textContent = achievement.name;
                text.appendChild(name);
                const desc = document.createElement('div');
                desc.style.fontSize = '14px';
                desc.style.color = '#7f8c8d';
                desc.textContent = achievement.desc;
                text.appendChild(desc);
                item.appendChild(text);
                list.appendChild(item);
            }
        }

        // Check Achievements
        function checkAchievements() {
            let updated = false;
            if (totalQuestionsAnswered === 1 && !achievements.firstAnswer.earned) {
                achievements.firstAnswer.earned = true;
                showAchievementUnlocked('firstAnswer');
                updated = true;
            }
            if (currentStreak >= 5 && !achievements.fiveStreak.earned) {
                achievements.fiveStreak.earned = true;
                showAchievementUnlocked('fiveStreak');
                updated = true;
            }
            const allCivilizations = Array.from(new Set(questions.flatMap(q => q.civilizations)));
            if (unlockedCivilizations.length === allCivilizations.length && 
                currentEra === eras[eras.length - 1].name && 
                !achievements.unlockAll.earned) {
                achievements.unlockAll.earned = true;
                showAchievementUnlocked('unlockAll');
                updated = true;
            }
            if (score >= 1000 && !achievements.perfectScore.earned) {
                achievements.perfectScore.earned = true;
                showAchievementUnlocked('perfectScore');
                updated = true;
            }
            if (totalQuestionsAnswered >= 50 && !achievements.historyBuff.earned) {
                achievements.historyBuff.earned = true;
                showAchievementUnlocked('historyBuff');
                updated = true;
            }
            if (updated) {
                saveAchievements();
                updateAchievementsDisplay();
            }
        }

        // Show Achievement Unlocked
        function showAchievementUnlocked(achievementKey) {
            const notification = document.getElementById('unlock-notification');
            notification.textContent = translations.achievementUnlocked.replace('{name}', achievements[achievementKey].name);
            notification.style.display = 'block';
            playSound('achievement-sound');
            setTimeout(() => {
                notification.style.display = 'none';
            }, 2500);
        }

        // Update UI
        function updateUI() {
            document.getElementById('title').textContent = translations.title;
            document.getElementById('next-question').textContent = translations.newQuestion;
            document.getElementById('hint-button').textContent = translations.hint;
            document.getElementById('reset-score').textContent = translations.resetScore;
            document.getElementById('score').textContent = `${translations.score}: ${score}`;
            document.getElementById('leaderboard').textContent = `${translations.highScore}: ${highScore}`;
            document.getElementById('streak-counter').textContent = `${translations.streak}: ${currentStreak}`;
            document.getElementById('progress').textContent = `${translations.unlockedCivs}: ${unlockedCivilizations.join(', ')}`;
            document.getElementById('era-info').textContent = `${translations.currentEra}: ${currentEra}`;
            document.getElementById('question-counter').textContent = `${translations.questionsAnswered}: ${totalQuestionsAnswered}`;
            document.getElementById('settings-title').textContent = translations.settings;
            document.getElementById('music-label').textContent = translations.musicLabel;
            document.getElementById('sound-label').textContent = translations.soundLabel;
            document.getElementById('timer-label').textContent = translations.timerLabel;
            document.getElementById('difficulty-label').textContent = translations.difficultyLabel;
            document.getElementById('achievements-title').textContent = translations.achievements;
            document.getElementById('music-toggle-setting').textContent = `${translations.musicLabel}: ${musicEnabled ? translations.disable : translations.enable}`;
            document.getElementById('sound-toggle-setting').textContent = `${translations.soundLabel}: ${soundEnabled ? translations.disable : translations.enable}`;
            document.getElementById('timer-toggle-setting').textContent = `${translations.timerLabel}: ${timerEnabled ? translations.disable : translations.enable}`;
            const timelineLabels = document.getElementById('timeline-labels');
            timelineLabels.innerHTML = '';
            eras.forEach(era => {
                const label = document.createElement('span');
                label.textContent = era.name.substring(0, 5);
                timelineLabels.appendChild(label);
            });
            updateMentorInfo();
        }

        // Update Mentor Information
        function updateMentorInfo() {
            const mentorDiv = document.getElementById('mentor');
            if (currentMentor) {
                mentorDiv.innerHTML = 
                    `${translations.mentor}: ${currentMentor.name}<br>` +
                    `<img id="mentor-img" src="${currentMentor.img}" alt="${currentMentor.name}" style="display: block;">` +
                    `<div style="font-style: italic; margin-top: 5px;">${currentMentor.quote}</div>`;
                document.getElementById('mentor-bonus').textContent = `${translations.mentorBonus}: x${currentMentor.bonus}`;
            } else {
                mentorDiv.innerHTML = translations.mentorNotSelected + '<br><img id="mentor-img" src="" style="display: none;">';
                document.getElementById('mentor-bonus').textContent = '';
            }
        }

        // Initialize Mentor Buttons
        function initMentorButtons() {
            const mentorDiv = document.getElementById('mentor');
            if (!currentMentor) {
                mentorDiv.innerHTML += `<br><button id="select-mentor">${translations.selectMentor}</button>`;
                document.getElementById('select-mentor').addEventListener('click', showMentorSelection);
            }
        }

        // Show Mentor Selection
        function showMentorSelection() {
            const mentorDiv = document.getElementById('mentor');
            mentorDiv.innerHTML = '';
            for (const key in mentors) {
                const mentor = mentors[key];
                const button = document.createElement('button');
                button.textContent = mentor.name;
                button.addEventListener('click', () => selectMentor(key));
                mentorDiv.appendChild(button);
            }
            playSound('button-sound');
        }

        // Select Mentor
        function selectMentor(mentorKey) {
            currentMentor = mentors[mentorKey];
            updateMentorInfo();
            updateUI();
            playSound('success-sound');
        }

        // Update Timeline
        function updateTimeline() {
            const marker = document.getElementById('timeline-marker');
            const era = eras.find(e => e.name === currentEra);
            marker.style.left = `${era.position}%`;
        }

        // Debounce Function
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Next Question
        function nextQuestion() {
            if (isProcessing) return;
            isProcessing = true;
            document.getElementById('next-question').disabled = true;
            clearInterval(timerInterval);

            const availableQuestions = questions.filter(q => 
                q.civilizations.some(civ => unlockedCivilizations.includes(civ)) &&
                (!q.unlockRequirement || correctAnswers >= q.unlockRequirement) &&
                !questionHistory.includes(q.question) &&
                (difficulty === 'easy' ? q.difficulty === 1 :
                 difficulty === 'medium' ? q.difficulty <= 2 : true)
            );

            if (availableQuestions.length === 0) {
                document.getElementById('question').textContent = translations.noQuestions;
                document.getElementById('choices').innerHTML = '';
                document.getElementById('result').textContent = '';
                document.getElementById('explanation').textContent = '';
                document.getElementById('hint').textContent = '';
                isProcessing = false;
                document.getElementById('next-question').disabled = false;
                return;
            }

            let filteredQuestions = availableQuestions;
            if (currentMentor) {
                const mentorSpecialtyQuestions = filteredQuestions.filter(q => 
                    q.civilizations.some(c => currentMentor.specialty.includes(c))
                );
                if (mentorSpecialtyQuestions.length > 0) {
                    filteredQuestions = mentorSpecialtyQuestions;
                }
            }

            currentQuestion = filteredQuestions[Math.floor(Math.random() * filteredQuestions.length)];
            questionHistory.push(currentQuestion.question);
            if (questionHistory.length > questions.length) {
                questionHistory = questionHistory.slice(-Math.floor(questions.length / 2));
            }

            displayQuestion(currentQuestion);
            startTimer();
            isProcessing = false;
            document.getElementById('next-question').disabled = false;
            playSound('page-sound');
        }

        const debouncedNextQuestion = debounce(nextQuestion, 300);

        // Display Question
        function displayQuestion(question) {
            document.getElementById('question').innerHTML = 
                `${question.question} <span class="difficulty-indicator difficulty-${question.difficulty === 1 ? 'easy' : 'medium-higher'}"></span>`;
            const choicesDiv = document.getElementById('choices');
            choicesDiv.innerHTML = '';
            const tagsDiv = document.createElement('div');
            tagsDiv.style.margin = '10px';
            question.civilizations.forEach(civ => {
                const tag = document.createElement('span');
                tag.className = 'civilization-tag';
                tag.textContent = civ;
                const difficultyIndicator = document.createElement('span');
                difficultyIndicator.className = `difficulty-indicator difficulty-${question.difficulty === 1 ? 'easy' : 'medium-higher'}`;
                tag.appendChild(difficultyIndicator);
                tagsDiv.appendChild(tag);
            });
            choicesDiv.appendChild(tagsDiv);
            question.choices.forEach((choice, index) => {
                const button = document.createElement('button');
                button.textContent = choice;
                button.addEventListener('click', () => checkAnswer(index, button));
                button.disabled = false;
                choicesDiv.appendChild(button);
            });
            updateTimeline();
        }

        // Start Timer
        function startTimer() {
            if (!timerEnabled) return;
            if (timerInterval) clearInterval(timerInterval);
            
            let timeLeft = 15;
            const timerBar = document.getElementById('timer-bar');
            timerBar.style.width = '100%';
            
            timerInterval = setInterval(() => {
                timeLeft -= 0.1;
                timerBar.style.width = `${(timeLeft / 15) * 100}%`;
                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    timerInterval = null;
                    checkAnswer(-1);
                }
            }, 100);
        }

        // Check Answer
        function checkAnswer(selectedIndex, button) {
            if (isProcessing) return;
            isProcessing = true;
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
            
            const choices = document.querySelectorAll('#choices button');
            for (let btn of choices) {
                btn.disabled = true;
            }
            
            let points = 0;
            totalQuestionsAnswered++;
            if (selectedIndex === currentQuestion.answer) {
                points = Math.round(10 * (currentMentor ? currentMentor.bonus : 1) * (1 + currentStreak * 0.1));
                score += points;
                currentStreak++;
                correctAnswers++;
                if (currentStreak > highestStreak) highestStreak = currentStreak;
                document.getElementById('result').textContent = translations.correct.replace('{points}', points).replace('{streak}', currentStreak);
                document.getElementById('result').style.color = '#27ae60';
                if (button) button.classList.add('correct');
                playSound('correct-sound');
                if (currentStreak % 3 === 0) {
                    playSound('streak-sound');
                }
            } else {
                currentStreak = 0;
                document.getElementById('result').textContent = translations.wrong;
                document.getElementById('result').style.color = '#e74c3c';
                if (button) button.classList.add('wrong');
                choices[currentQuestion.answer].classList.add('correct');
                playSound('wrong-sound');
            }
            
            highScore = Math.max(score, highScore);
            document.getElementById('explanation').textContent = currentQuestion.explanation;
            saveGameState();
            checkUnlocks();
            checkAchievements();
            updateUI();
            
            setTimeout(() => {
                for (let btn of choices) {
                    btn.disabled = false;
                    btn.classList.remove('correct', 'wrong');
                }
                isProcessing = false;
            }, 1000);
        }

        // Show Hint
        function showHint() {
            if (isProcessing) return;
            isProcessing = true;
            if (!currentMentor) {
                document.getElementById('hint').textContent = translations.noMentorHint;
                isProcessing = false;
                return;
            }
            if (!currentQuestion) {
                document.getElementById('hint').textContent = translations.noQuestionHint;
                isProcessing = false;
                return;
            }
            
            const hintText = currentMentor.hintStyle + 
                currentQuestion.choices[currentQuestion.answer];
            document.getElementById('hint').textContent = hintText;
            score = Math.max(0, score - 5);
            saveGameState();
            updateUI();
            playSound('hint-sound');
            setTimeout(() => {
                isProcessing = false;
            }, 500);
        }

        // Check Unlocks
        function checkUnlocks() {
            const allCivilizations = Array.from(new Set(questions.flatMap(q => q.civilizations)));
            const lockedCivilizations = allCivilizations.filter(c => !unlockedCivilizations.includes(c));
            lockedCivilizations.forEach(civ => {
                const civQuestions = questions.filter(q => q.civilizations.includes(civ));
                const requiredCorrect = civQuestions[0]?.unlockRequirement || 5;
                if (correctAnswers >= requiredCorrect) {
                    unlockedCivilizations.push(civ);
                    showUnlockNotification(translations.civUnlocked.replace('{civ}', civ));
                    playSound('unlock-sound');
                }
            });

            const currentEraIndex = eras.findIndex(e => e.name === currentEra);
            if (currentEraIndex < eras.length - 1) {
                const nextEra = eras[currentEraIndex + 1];
                const requiredForNextEra = 5 * (currentEraIndex + 1);
                if (correctAnswers >= requiredForNextEra) {
                    currentEra = nextEra.name;
                    timelinePosition = nextEra.position;
                    showUnlockNotification(translations.eraUnlocked.replace('{era}', nextEra.name));
                    playSound('era-change-sound');
                    updateTimeline();
                }
            }
        }

        // Show Unlock Notification
        function showUnlockNotification(message) {
            const notification = document.getElementById('unlock-notification');
            notification.textContent = message;
            notification.style.display = 'block';
            setTimeout(() => {
                notification.style.display = 'none';
                document.getElementById('progress').classList.add('correct');
                setTimeout(() => {
                    document.getElementById('progress').classList.remove('correct');
                    updateUI();
                }, 1000);
            }, 2500);
        }

        // Reset Score
        function resetScore() {
            if (isProcessing) return;
            isProcessing = true;
            score = 0;
            correctAnswers = 0;
            currentStreak = 0;
            questionHistory = [];
            unlockedCivilizations = ['Mesopotamia', 'Ancient Egypt'];
            currentEra = eras[0].name;
            timelinePosition = 0;
            clearInterval(timerInterval);
            saveGameState();
            document.getElementById('result').textContent = translations.scoreReset;
            document.getElementById('streak-counter').style.color = '';
            updateUI();
            setTimeout(() => {
                isProcessing = false;
            }, 500);
            playSound('button-sound');
        }

        // Initialize
        window.onload = initGame;
    </script>
</body>
</html>